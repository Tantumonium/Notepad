<script>
    $(document).ready(function() {
        let editorInstance;
        const $notesList          = $('#notes-list');
        const $cardTitle          = $('.card-title');
        const $cardBody           = $('.card-body');
        const $editorContainer    = $('#editor');
        const $toolbarContainer   = $('#toolbar-container');
        const $confirmDeleteBtn   = $('#confirmDeleteBtn');
        const $deleteConfirmation = $('#deleteConfirmation');
        let isBlurListenerAttached = false;

        // Initialize
        initialize();

        // Function to initialize the application
        function initialize() {
            google.script.run.withSuccessHandler(renderNotesList).getNotes();
            $confirmDeleteBtn.click(handleConfirmDelete);
            initializeEditor(); // Ensure the editor is initialized at the start
        }

        // Function to render notes list
        function renderNotesList(notes) {
            $notesList.empty();
            notes.forEach(note => {
                const $noteItem = createNoteItem(note);
                $notesList.append($noteItem);
            });
        }

        // Function to create a note item element
        function createNoteItem(note) {
            const $noteItem = $(`
                <li class="list-group-item p-0" data-id="${note.id}">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-light text-start w-100 d-flex align-items-center btn-item-title">
                            <i class="bi bi-card-text me-2"></i>
                            <span class="flex-grow-1">${note.title}</span>
                        </button>
                        <button type="button" class="btn btn-light btn-item-delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </li>
            `);
            $noteItem.find('.btn-item-title').click(event => handleNoteClick(note.id));
            $noteItem.find('.btn-item-delete').click(event => handleDeleteClick(event, note.id));
            return $noteItem;
        }

        // Function to handle note click
        function handleNoteClick(noteId) {
            google.script.run.withSuccessHandler(renderNoteDetails).getNoteById(noteId);
            $('.btn-item-title').removeClass('active');
            $(`.list-group-item[data-id="${noteId}"] .btn-item-title`).addClass('active');
            $editorContainer.removeClass('ck-blurred').addClass('ck-focused');
        }

        // Function to render note details
        function renderNoteDetails(note) {
            if (!note) {
                console.error('Note is null or undefined'); // Debug log
                return;
            }

            $cardBody.data('noteId', note.id);
            $cardTitle.val(note.title);

            if (editorInstance) {
                editorInstance.setData(note.content);
            } else {
                initializeEditor().then(() => {
                    editorInstance.setData(note.content);
                });
            }

            $cardTitle.off('input').on('input', handleTitleInput);
            $cardBody.show();

            // Attach blur event listeners for saving if not already attached
            if (!isBlurListenerAttached) {
                $cardTitle.on('blur', handleSaveNote);
                if (editorInstance) {
                    editorInstance.editing.view.document.on('blur', handleSaveNote, { priority: 'lowest' });
                }
                isBlurListenerAttached = true;
            }
        }

        // Function to handle title input
        function handleTitleInput() {
            const noteId = $cardBody.data('noteId');
            const newTitle = $cardTitle.val();
            google.script.run.editNoteTitle(noteId, newTitle);
            $(`.list-group-item[data-id="${noteId}"] .btn-item-title span`).text(newTitle);
        }

        // Function to handle delete click
        function handleDeleteClick(event, noteId) {
            event.stopPropagation();
            $deleteConfirmation.modal('show');
            $confirmDeleteBtn.data('note-id', noteId);
        }

        // Function to handle confirm delete
        function handleConfirmDelete() {
            const noteId = $(this).data('note-id');
            deleteNoteAndRenderList(noteId);
            $deleteConfirmation.modal('hide');
        }

        // Function to add a new note
        function addNote() {
            google.script.run.withSuccessHandler(notes => {
                renderNotesList(notes);
                const newNote = notes[notes.length - 1];
                renderNoteDetails(newNote);
                $(`.list-group-item[data-id="${newNote.id}"]`).addClass('active');
                $cardTitle.focus();
            }).addNote();
        }

        // Function to delete a note and render the list again
        function deleteNoteAndRenderList(noteId) {
            google.script.run.withSuccessHandler(renderNotesList).deleteNote(noteId);
            $cardBody.hide();
        }

        // Function to initialize the CKEditor
        function initializeEditor() {
            return DecoupledEditor
                .create($editorContainer[0], {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'strikethrough', 'underline', '|',
                        'bulletedList', 'numberedList', '|',
                        'outdent', 'indent', '|',
                        'alignment', '|',
                        'link', 'blockQuote', 'insertTable',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|'
                    ],
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                            { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' },
                            { model: 'heading5', view: 'h5', title: 'Heading 5', class: 'ck-heading_heading5' }
                        ]
                    }
                })
                .then(editor => {
                    editorInstance = editor;
                    $toolbarContainer.append(editor.ui.view.toolbar.element);
                })
                .catch(error => {
                    console.error('Error initializing editor:', error);
                });
        }

        // Function to handle save note on blur
        function handleSaveNote() {
            const noteId = $cardBody.data('noteId');
            const title = $cardTitle.val();
            const content = editorInstance.getData();
            const note = {
                id: noteId,
                title: title,
                content: content
            };
            console.log('Saving note:', note); // Debugging log
            google.script.run.withSuccessHandler(() => {
                console.log('Note saved successfully');
            }).saveNote(note);
        }

        // Expose functions to global scope for button click handlers
        window.addNote = addNote;
    });
</script>
